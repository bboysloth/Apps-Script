/**
 * Generates the Visuals Dashboard.
 * v2.7.9 Layout Update:
 * 1. Scorecards Row 1 (3-4): Total, External, Internal, Total Time.
 * 2. Scorecards Row 2 (5-6): In Person, SE Lead, Nights Away (Starts A5).
 * 3. Interactive Table: Moves down to G10.
 * 4. Pie Chart: Moves down to A10.
 */
function generateDashboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dataSheet = ss.getSheetByName("Untagged Meetings");
  const visualsSheetName = "Visuals";
  let visualsSheet = ss.getSheetByName(visualsSheetName);
  if (!visualsSheet) { visualsSheet = ss.insertSheet(visualsSheetName); } 
  else { 
      visualsSheet.getCharts().forEach(c => visualsSheet.removeChart(c));
      visualsSheet.clear(); 
  }
  
  visualsSheet.showColumns(1, visualsSheet.getMaxColumns());
  visualsSheet.getRange("A1:Z1000").setFontFamily("Poppins").setFontSize(10);
  
  const lastRow = dataSheet.getLastRow();
  if (lastRow < 2) { SpreadsheetApp.getUi().alert("No data found in Untagged Meetings sheet."); return; }
  
  // Read 15 columns (A-O)
  const data = dataSheet.getRange(2, 1, lastRow - 1, 15).getValues();
  
  let total = data.length, external = 0, seLead = 0, inPerson = 0, totalMinutes = 0, totalNights = 0;
  const tagCounts = new Map();
  const tagTime = new Map(); 

  data.forEach(row => {
    if (row[3] === true) external++;
    if (row[4] === true) seLead++;
    if (row[5] === true) inPerson++;
    
    const tagName = row[6];
    const duration = row[13]; // Col N
    const nights = row[14];   // Col O
    
    if (typeof duration === 'number') totalMinutes += duration;
    if (typeof nights === 'number') totalNights += nights;
    
    if (tagName && tagName.trim() !== "") { 
        tagCounts.set(tagName, (tagCounts.get(tagName) || 0) + 1);
        if (typeof duration === 'number') {
            tagTime.set(tagName, (tagTime.get(tagName) || 0) + duration);
        }
    }
  });
  let internal = total - external;

  // --- SCORECARD SECTION ---
  const bg = "#283e4d";
  const fg = "white";

  // ROW 1 (Rows 3-4): Main Metrics
  // A-B: Total, C-D: External, E-F: Internal
  const row1Cards = [
    { title: "Total Meetings", val: total, col: 1 },
    { title: "External Meetings", val: external, col: 3 },
    { title: "Internal Meetings", val: internal, col: 5 }
  ];
  
  row1Cards.forEach(card => {
    visualsSheet.getRange(3, card.col, 1, 2).merge().setValue(card.title).setFontWeight("bold").setHorizontalAlignment("center").setBackground(bg).setFontColor(fg).setBorder(true, true, true, true, true, true);
    visualsSheet.getRange(4, card.col, 1, 2).merge().setValue(card.val).setFontSize(15).setFontWeight("bold").setHorizontalAlignment("center").setBorder(true, true, true, true, true, true);
  });

  // G-H: Total Time Spent (Dynamic)
  visualsSheet.getRange("O4").setFormula("=SUM(M11:M)"); // Sums hidden M (Raw Minutes) starting at Row 11
  visualsSheet.getRange(3, 7, 1, 2).merge().setValue("Total Time Spent").setFontWeight("bold").setHorizontalAlignment("center").setBackground(bg).setFontColor(fg).setBorder(true, true, true, true, true, true);
  visualsSheet.getRange(4, 7, 1, 2).merge().setFormula(`=TEXT(O4/1440, "[h]""hr ""mm""min""")`).setFontSize(15).setFontWeight("bold").setHorizontalAlignment("center").setBorder(true, true, true, true, true, true);


  // ROW 2 (Rows 5-6): Secondary Metrics
  // A-B: In Person, C-D: SE Lead, E-F: Nights Away
  const row2Cards = [
    { title: "In Person Mtgs", val: inPerson, col: 1 },
    { title: "SE Lead Mtgs", val: seLead, col: 3 },
    { title: "Nights Away", val: totalNights, col: 5 }
  ];

  row2Cards.forEach(card => {
    visualsSheet.getRange(5, card.col, 1, 2).merge().setValue(card.title).setFontWeight("bold").setHorizontalAlignment("center").setBackground(bg).setFontColor(fg).setBorder(true, true, true, true, true, true);
    visualsSheet.getRange(6, card.col, 1, 2).merge().setValue(card.val).setFontSize(15).setFontWeight("bold").setHorizontalAlignment("center").setBorder(true, true, true, true, true, true);
  });

  // Formatting Rules (Apply to both Row 4 and Row 6 values)
  const scRanges = [visualsSheet.getRange(4, 1, 1, 6), visualsSheet.getRange(6, 1, 1, 6)];
  let scRules = [
      SpreadsheetApp.newConditionalFormatRule().whenNumberLessThan(100).setFontColor("#38761d").setBold(true).setRanges(scRanges).build(),
      SpreadsheetApp.newConditionalFormatRule().whenNumberBetween(100, 150).setFontColor("#bf9000").setBold(true).setRanges(scRanges).build(),
      SpreadsheetApp.newConditionalFormatRule().whenNumberGreaterThan(150).setFontColor("#cc0000").setBold(true).setRanges(scRanges).build()
  ];
  visualsSheet.setConditionalFormatRules(scRules);


  // --- INTERACTIVE TAG TABLE (Starts at G10) ---
  visualsSheet.getRange("G10").setValue("Hide").setFontWeight("bold").setBackground(bg).setFontColor(fg);
  visualsSheet.getRange("H10").setValue("Tag Name").setFontWeight("bold").setBackground(bg).setFontColor(fg);
  visualsSheet.getRange("I10").setValue("Count").setFontWeight("bold").setBackground(bg).setFontColor(fg);
  visualsSheet.getRange("J10").setValue("Percentage").setFontWeight("bold").setBackground(bg).setFontColor(fg);
  visualsSheet.getRange("K10").setValue("Total Time").setFontWeight("bold").setBackground(bg).setFontColor(fg);
  
  const sortedTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]);
  if (sortedTags.length > 0) {
    const tableData = sortedTags.map(([tag, count]) => {
        const timeInMinutes = tagTime.get(tag) || 0;
        return [tag, count, _formatMinutesToHours(timeInMinutes)];
    });
    
    // Write Data (Start Row 11)
    // Tag Name (H), Count (I), Formatted Time (K)
    visualsSheet.getRange(11, 8, tableData.length, 2).setValues(tableData.map(row => [row[0], row[1]])); 
    visualsSheet.getRange(11, 11, tableData.length, 1).setValues(tableData.map(row => [row[2]])); 
    
    // Raw Minutes to Hidden Col M
    visualsSheet.getRange(11, 13, tableData.length, 1).setValues(tableData.map(row => [tagTime.get(row[0]) || 0])); 
    
    // Checkboxes in G
    visualsSheet.getRange(11, 7, visualsSheet.getMaxRows() - 10, 1).removeCheckboxes();
    visualsSheet.getRange(11, 7, sortedTags.length, 1).insertCheckboxes();
    
    const numRows = sortedTags.length;
    const formulas = [];
    
    for (let i = 11; i < 11 + numRows; i++) {
        formulas.push([
            `=IF(G${i}=TRUE, "-", I${i}/SUMIF($G$11:$G,FALSE,$I$11:$I))`, // J (Pct)
            `=IF(G${i}=TRUE, "-", TEXT(M${i}/1440, "[h]""hr ""mm""min"""))` // K (Time)
        ]);
    }
    visualsSheet.getRange(11, 10, numRows, 2).setFormulas(formulas);
    visualsSheet.getRange(11, 10, numRows, 1).setNumberFormat("0.0%"); 
    
    visualsSheet.getRange(10, 7, sortedTags.length + 1, 5).setBorder(true, true, true, true, true, true);
  }

  // --- PIE CHART (Starts at A10) ---
  
  // Chart Source (N, O)
  visualsSheet.getRange("N10").setValue("Chart Source (Hidden)").setFontStyle("italic");
  visualsSheet.getRange("N11").setFormula("=FILTER(H11:I, G11:G=FALSE)");
  visualsSheet.hideColumns(13, 4); // Hide M, N, O, P

  if (sortedTags.length > 0) {
    const chartRange = visualsSheet.getRange("N11:O" + (11 + sortedTags.length));
    const pieChart = visualsSheet.newChart().setChartType(Charts.ChartType.PIE).addRange(chartRange)
      .setOption('title', 'Meeting Tag Breakdown').setOption('pieSliceText', 'percentage').setOption('legend', { position: 'right' })
      .setOption('is3D', true)
      .setOption('colors', ['#283e4d', '#3d9fd2', '#757475', '#34545e', '#959ea7', '#546e7a', '#78909c', '#63c0f2', '#1f4e6a', '#de6662', '#c45551', '#e68a87'])
      .setOption('titleTextStyle', { fontName: 'Poppins', fontSize: 20, bold: true })
      .setOption('legend.textStyle', { fontName: 'Poppins', fontSize: 10 })
      .setOption('pieSliceTextStyle', { fontName: 'Poppins', color: 'white' })
      .setOption('height', 400).setOption('width', 700).setPosition(10, 1, 0, 0).build(); // Row 10, Col 1
    visualsSheet.insertChart(pieChart);
  } else { visualsSheet.getRange("A10").setValue("No tagged meetings found."); }

  const selectedQuarter = getConfig("QuarterOverride");
  let dateString = `Last ${getConfig("DaysBack")} Days`;
  if (selectedQuarter && selectedQuarter !== "None") { dateString = selectedQuarter; }
  visualsSheet.getRange("A1").setValue(`Dashboard for: ${dateString} (Generated: ${new Date().toLocaleString()})`).setFontWeight("bold").setFontSize(12);

  visualsSheet.setColumnWidth(10, 120); // Col J
  visualsSheet.setColumnWidth(11, 120); // Col K
  visualsSheet.autoResizeColumns(7, 3); 
  ss.setActiveSheet(visualsSheet);
}
